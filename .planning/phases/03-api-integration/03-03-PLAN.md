---
phase: 03-api-integration
plan: 03
type: execute
wave: 3
depends_on: [03-01, 03-02]
files_modified:
  - backend/main.py
  - backend/.env.example
autonomous: true

must_haves:
  truths:
    - "CORS middleware configured with environment-specific origins"
    - "Development mode allows all origins for local testing"
    - "Production mode restricts to specific frontend domains"
    - "CORS configuration supports credentials and all necessary headers"
  artifacts:
    - path: "backend/main.py"
      contains: "CORSMiddleware with environment-specific allow_origins"
      contains: "os.getenv('CORS_ORIGINS') or '*'"
    - path: "backend/.env.example"
      contains: "CORS_ORIGINS environment variable with documentation"
      contains: "ENVIRONMENT variable (development|production)"
  key_links:
    - from: "backend/main.py"
      to: "environment variables"
      via: "os.getenv() calls for CORS configuration"
      pattern: "os\\.getenv\\(['\"]CORS_ORIGINS|ENVIRONMENT['\"]\\)"
---

<objective>
Configure CORS middleware for React frontend integration with environment-specific origin restrictions.

Purpose: Allow frontend to fetch API resources from different origin while maintaining security in production.
Output: Working CORS configuration that supports local development and production deployment.
</objective>

<execution_context>
@/Users/daniswhoiam/.claude/get-shit-done/workflows/execute-plan.md
@/Users/daniswhoiam/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-api-integration/03-RESEARCH.md
@backend/main.py
@backend/.env.example
</context>

<tasks>

<task type="auto">
  <name>Add environment-specific CORS configuration to main.py</name>
  <files>backend/main.py</files>
  <action>
    Update CORS middleware configuration in backend/main.py:

    1. Import os module (add to imports if not present):
       import os

    2. Replace existing CORS middleware configuration (lines 59-67) with environment-aware version:

       # Get environment and CORS origins from environment
       environment = os.getenv("ENVIRONMENT", "development")

       # Parse CORS origins from comma-separated string
       cors_origins_str = os.getenv("CORS_ORIGINS", "*")
       if cors_origins_str == "*":
           cors_origins = ["*"]
       else:
           cors_origins = [origin.strip() for origin in cors_origins_str.split(",")]

       # Log CORS configuration in development
       if environment == "development":
           print(f"CORS allowed origins: {cors_origins}")

       # Add CORS middleware
       app.add_middleware(
           CORSMiddleware,
           allow_origins=cors_origins,
           allow_credentials=True,
           allow_methods=["GET", "POST", "PUT", "DELETE", "OPTIONS"],
           allow_headers=["*"],
           expose_headers=["Content-Range"],
           max_age=3600,  # Cache preflight responses for 1 hour
       )

    3. Update docstring comment above CORS middleware:
       OLD: "NOTE: Restrict origins in production"
       NEW: "CORS configured via ENVIRONMENT and CORS_ORIGINS environment variables"
       "  Development: Allows all origins or configured origins"
       "  Production: Restrict to specific frontend domains"

    This provides:
    - Flexible configuration via environment variables
    - Comma-separated list of origins for production
    - Wildcard support for local development
    - Logging in development mode for debugging
  </action>
  <verify>
    Run: docker compose exec backend python -c "from backend.main import app; print('CORS loaded')"
    Output: CORS loaded (no import errors)
  </verify>
  <done>
    CORS configuration reads from ENVIRONMENT and CORS_ORIGINS environment variables
    Comma-separated origins parsed correctly for production use
    Development mode logs allowed origins on startup
  </done>
</task>

<task type="auto">
  <name>Add CORS configuration to .env.example</name>
  <files>backend/.env.example</files>
  <action>
    Update backend/.env.example to include CORS configuration documentation:

    1. Add CORS configuration section at the end of file:

       # ========================================
       # CORS Configuration
       # ========================================
       # Environment: "development" or "production"
       # Development: Allows all origins by default
       # Production: Must specify CORS_ORIGINS for security
       ENVIRONMENT=development

       # CORS allowed origins (comma-separated)
       # - Development: Use "*" to allow all origins
       # - Production: Specify exact domains, e.g., "https://yourdomain.com,https://www.yourdomain.com"
       # - Local React dev: "http://localhost:5173,http://localhost:3000"
       CORS_ORIGINS=*

    2. If backend/.env.example doesn't exist, create it with all existing environment variables from main.py:
       - DATABASE_URL (from existing code)
       - SQL_ECHO (from existing code)
       - ASKNEWS_CLIENT_ID (from pipeline clients)
       - ASKNEWS_CLIENT_SECRET (from pipeline clients)
       - ENVIRONMENT (new)
       - CORS_ORIGINS (new)

    Check backend/pipeline/clients/asknews.py for existing environment variable patterns.

    This provides clear documentation for production deployment configuration.
  </action>
  <verify>
    Run: grep -E "ENVIRONMENT|CORS_ORIGINS" /Users/daniswhoiam/Projects/vibecheck/backend/.env.example
    Output shows both variables with documentation
  </verify>
  <done>
    .env.example documents ENVIRONMENT and CORS_ORIGINS with clear examples
    Production security guidance included (restrict to specific domains)
    Development defaults documented (allow all origins)
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Restart backend with production CORS settings:
   docker compose restart backend
   docker compose logs backend | grep "CORS allowed origins"

2. Test development mode (default):
   curl -H "Origin: http://localhost:5173" \
        -H "Access-Control-Request-Method: GET" \
        -X OPTIONS http://localhost:8000/entities
   - Should return 200
   - Response headers should include Access-Control-Allow-Origin: *

3. Test with specific origins:
   Update docker-compose.yml backend service environment:
   CORS_ORIGINS=http://localhost:5173,https://example.com
   Restart backend and check logs show specific origins

4. Test CORS preflight request:
   curl -v -H "Origin: http://localhost:5173" \
              -H "Access-Control-Request-Method: GET" \
              -X OPTIONS http://localhost:8000/entities/1/sentiment
   - Should return 204 No Content
   - Headers should include Access-Control-Allow-Origin, Access-Control-Allow-Methods

5. Test actual GET request with Origin:
   curl -v -H "Origin: http://localhost:5173" \
              http://localhost:8000/entities
   - Should return 200
   - Response headers should include Access-Control-Allow-Origin header

6. Verify .env.example completeness:
   cat backend/.env.example | grep -E "^[A-Z_]+="
   Should show all required environment variables including new CORS variables

If any test fails, review task actions and verify implementation matches specifications.
</verification>

<success_criteria>
Phase 3 Plan 03 is complete when:
- CORS middleware configuration uses environment variables for origin control
- Development mode (ENVIRONMENT=development) allows all origins by default
- Production mode can restrict to specific domains via CORS_ORIGINS
- CORS preflight requests return correct headers (Access-Control-Allow-Origin, etc.)
- .env.example documents CORS configuration with production security guidance
- Backend logs show allowed origins in development mode for debugging
</success_criteria>

<output>
After completion, create `.planning/phases/03-api-integration/03-03-SUMMARY.md` with:
- CORS configuration strategy (environment-specific origins)
- Security considerations (production restrictions, wildcard avoidance)
- Development workflow (local testing with Vite dev server)
- Production deployment steps (environment variable setup)
- Next steps (frontend integration testing, Phase 3 completion)
</output>
