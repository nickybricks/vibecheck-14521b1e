---
phase: 03-api-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/api/schemas/__init__.py
  - backend/api/schemas/entity.py
  - backend/api/schemas/sentiment.py
  - backend/api/routes/__init__.py
  - backend/api/routes/entities.py
  - backend/main.py
autonomous: true

must_haves:
  truths:
    - "GET /entities returns all tracked AI entities with latest sentiment"
    - "GET /entities/{id} returns single entity with 404 for non-existent"
    - "Response uses Pydantic schemas for automatic validation"
    - "Routes are registered with FastAPI app"
  artifacts:
    - path: "backend/api/schemas/entity.py"
      provides: "Entity response schemas"
      exports: ["EntitySchema", "EntityDetailSchema"]
    - path: "backend/api/schemas/sentiment.py"
      provides: "Sentiment response schemas"
      exports: ["SentimentPointSchema"]
    - path: "backend/api/routes/entities.py"
      provides: "Entity listing and detail endpoints"
      exports: ["router"]
    - path: "backend/main.py"
      contains: "app.include_router(entities.router)"
  key_links:
    - from: "backend/api/routes/entities.py"
      to: "db.models.Entity"
      via: "SQLAlchemy select queries"
      pattern: "select\\(Entity\\)"
    - from: "backend/api/routes/entities.py"
      to: "api.schemas.entity"
      via: "Pydantic model_validate"
      pattern: "EntitySchema\\.model_validate"
---

<objective>
Create Pydantic schemas and API endpoints for querying entities with latest sentiment scores.

Purpose: Provide frontend with list of tracked AI models/tools and individual entity details for the entities overview page.
Output: Working GET /entities and GET /entities/{id} endpoints returning validated JSON responses.
</objective>

<execution_context>
@/Users/daniswhoiam/.claude/get-shit-done/workflows/execute-plan.md
@/Users/daniswhoiam/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-api-integration/03-RESEARCH.md
@backend/db/models.py
@backend/db/session.py
@backend/main.py
@backend/api/routes/health.py
</context>

<tasks>

<task type="auto">
  <name>Create Pydantic schemas for entity responses</name>
  <files>backend/api/schemas/__init__.py</files>
  <files>backend/api/schemas/entity.py</files>
  <action>
    Create backend/api/schemas/ directory structure:

    1. Create backend/api/schemas/__init__.py:
       - Empty file to make it a package

    2. Create backend/api/schemas/entity.py with:
       - EntitySchema: Basic entity representation
         * id (int)
         * name (str)
         * category (str) - "model" or "tool"
         * created_at (datetime)
       - EntityDetailSchema: Extended entity with latest sentiment
         * All EntitySchema fields
         * latest_sentiment (float | None) - Most recent sentiment score

    Use Pydantic v2 syntax (model_config, computed_field if needed).
    All datetime fields should use ISO 8601 format (FastAPI default).

    Reference backend/db/models.py Entity model for field types.
    Use from_attributes=True to support ORM model conversion.
  </action>
  <verify>
    Python: from backend.api.schemas.entity import EntitySchema, EntityDetailSchema
    No import errors
  </verify>
  <done>
    EntitySchema and EntityDetailSchema classes defined with correct fields
    Both schemas have from_attributes=True for ORM model support
  </done>
</task>

<task type="auto">
  <name>Implement GET /entities listing endpoint</name>
  <files>backend/api/routes/entities.py</files>
  <action>
    Create backend/api/routes/entities.py with entity listing endpoint:

    1. Import dependencies:
       - APIRouter, Depends from fastapi
       - AsyncSession from sqlalchemy.ext.asyncio
       - select from sqlalchemy
       - Entity from db.models
       - EntitySchema from api.schemas.entity
       - get_session from db.session

    2. Create router: APIRouter(prefix="/entities", tags=["entities"])

    3. Implement GET /entities endpoint:
       - Async function accepting session: AsyncSession = Depends(get_session)
       - Query: select(Entity).order_by(Entity.name)
       - Execute: await session.execute(query)
       - Return: [EntitySchema.model_validate(e) for e in result.scalars().all()]

    4. Add docstring explaining response structure
  </action>
  <verify>
    Run: docker compose exec backend python -c "from backend.api.routes.entities import router; print(len(router.routes))"
    Output: 1 (single GET /entities route registered)
  </verify>
  <done>
    GET /entities endpoint returns list of all entities ordered by name
    Response uses EntitySchema for automatic validation
  </done>
</task>

<task type="auto">
  <name>Implement GET /entities/{id} detail endpoint</name>
  <files>backend/api/routes/entities.py</files>
  <action>
    Add entity detail endpoint to backend/api/routes/entities.py:

    1. Implement GET /entities/{entity_id} endpoint:
       - Path parameter: entity_id (int)
       - Dependency: session: AsyncSession = Depends(get_session)
       - Query: select(Entity).where(Entity.id == entity_id)
       - Execute and scalar_one_or_none()
       - Raise HTTPException(status_code=404) if entity is None
       - Return: EntityDetailSchema.model_validate(entity)

    2. Import HTTPException from fastapi

    3. For latest_sentiment in EntityDetailSchema:
       - Leave as None for now (Plan 02 will populate from SentimentTimeseries)
       - Add comment: "TODO: Populate from SentimentTimeseries in plan 03-02"

    4. Add docstring with 404 behavior
  </action>
  <verify>
    Run: docker compose exec backend python -c "from backend.api.routes.entities import router; print([r.path for r in router.routes])"
    Output includes: /entities/{entity_id}
  </verify>
  <done>
    GET /entities/{id} returns entity detail or 404 for non-existent entity
    HTTPException raised with status_code=404 and descriptive detail message
  </done>
</task>

<task type="auto">
  <name>Register entities router with FastAPI app</name>
  <files>backend/main.py</files>
  <action>
    Update backend/main.py to include entities router:

    1. Add import below health import:
       from api.routes import entities

    2. Below app.include_router(health.router), add:
       app.include_router(entities.router)

    This makes the entities endpoints available at /entities paths.
  </action>
  <verify>
    Run: docker compose restart backend && docker compose logs backend | grep "Registered.*scheduled jobs"
    Then: curl http://localhost:8000/entities
    Status: 200 OK
  </verify>
  <done>
    FastAPI app includes entities router
    GET /entities returns 200 with JSON array of entity objects
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Start backend: docker compose up -d backend
2. Wait for startup: docker compose logs -f backend | grep "Application startup"
3. Test entity listing: curl http://localhost:8000/entities
   - Should return 200
   - Response should be JSON array with Entity objects
   - Each entity has id, name, category, created_at
4. Test entity detail: curl http://localhost:8000/entities/1
   - Should return 200 with EntityDetail object
5. Test 404: curl http://localhost:8000/entities/99999
   - Should return 404 with error detail message
6. Check OpenAPI docs: curl http://localhost:8000/openapi.json | jq '.paths."/entities"'
   - GET operation documented with correct tags and responses

If any test fails, review task actions and verify implementation matches specifications.
</verification>

<success_criteria>
Phase 3 Plan 01 is complete when:
- GET /entities returns all entities from database (10 curated entities from Phase 1)
- GET /entities/{id} returns single entity or 404
- Both endpoints return properly validated JSON via Pydantic schemas
- Endpoints are documented in automatic OpenAPI docs at /docs
- No errors in backend logs during request handling
</success_criteria>

<output>
After completion, create `.planning/phases/03-api-integration/03-01-SUMMARY.md` with:
- Implementation decisions (why these fields, why this structure)
- API routes created (paths, methods)
- Schemas defined (EntitySchema, EntityDetailSchema)
- Any deviations from plan and rationale
- Next steps (Plan 02: sentiment time-series endpoints)
</output>
